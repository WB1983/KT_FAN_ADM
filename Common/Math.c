#include <stdint.h>
#include <stdlib.h>
#include <stdbool.h>
#include <stdio.h>

#include "Math.h"     /* Include own header */

/*****************************************************************************************************************
 * LOCAL DEFINITIONS *********************************************************************************************
 *****************************************************************************************************************/
#define FPM_CORDIC_ITERATIONS      14      /**< Number of CORDIC iterations */

/**
  \brief Definition of the CORDIC scale factor
 
  The scaling factor is equal to 0.607253
*/
#define FPM_CORDIC_SCALE_FACTOR_Q16        (Q16(0.607253))

/*****************************************************************************************************************
 * LOCAL CONSTANTS ***********************************************************************************************
 *****************************************************************************************************************/
/**
  \brief Definition of the fixed point conversion macro
 
  The passed number is converted to the standard fixed point format as it is
  defined above (refer to FPM_GLOBAL_FP_FORMAT)
 
*/
#define Q28(x)    ((TFp)((x)*268435456.0))   /**< Q28 fixed point number definition macro */
#define Q27(x)    ((TFp)((x)*134217728.0))   /**< Q27 fixed point number definition macro */
#define Q26(x)    ((TFp)((x)*67108864.0))    /**< Q26 fixed point number definition macro */
#define Q25(x)    ((TFp)((x)*33554432.0))    /**< Q25 fixed point number definition macro */
#define Q24(x)    ((TFp)((x)*16777216.0))    /**< Q24 fixed point number definition macro */
#define Q23(x)    ((TFp)((x)*8388608.0))     /**< Q23 fixed point number definition macro */
#define Q22(x)    ((TFp)((x)*4194304.0))     /**< Q22 fixed point number definition macro */
#define Q21(x)    ((TFp)((x)*2097152.0))     /**< Q21 fixed point number definition macro */
#define Q20(x)    ((TFp)((x)*1048576.0))     /**< Q20 fixed point number definition macro */
#define Q19(x)    ((TFp)((x)*524288.0))      /**< Q19 fixed point number definition macro */
#define Q18(x)    ((TFp)((x)*262144.0))      /**< Q18 fixed point number definition macro */
#define Q17(x)    ((TFp)((x)*131072.0))      /**< Q17 fixed point number definition macro */
#define Q16(x)    ((TFp)((x)*65536.0))       /**< Q16 fixed point number definition macro */
#define Q15(x)    ((TFp)((x)*32768.0))       /**< Q15 fixed point number definition macro */
#define Q14(x)    ((TFp)((x)*16384.0))       /**< Q14 fixed point number definition macro */
#define Q13(x)    ((TFp)((x)*8192.0))        /**< Q13 fixed point number definition macro */
#define Q12(x)    ((TFp)((x)*4096.0))        /**< Q12 fixed point number definition macro */
#define Q11(x)    ((TFp)((x)*2048.0))        /**< Q11 fixed point number definition macro */
#define Q10(x)    ((TFp)((x)*1024.0))        /**< Q10 fixed point number definition macro */
#define Q9(x)     ((TFp)((x)*512.0))         /**< Q9 fixed point number definition macro */
#define Q8(x)     ((TFp)((x)*256.0))         /**< Q8 fixed point number definition macro */
#define Q7(x)     ((TFp)((x)*128.0))         /**< Q7 fixed point number definition macro */
#define Q6(x)     ((TFp)((x)*64.0))          /**< Q6 fixed point number definition macro */
#define Q5(x)     ((TFp)((x)*32.0))          /**< Q5 fixed point number definition macro */
#define Q4(x)     ((TFp)((x)*16.0))          /**< Q4 fixed point number definition macro */
#define Q3(x)     ((TFp)((x)*8.0))           /**< Q3 fixed point number definition macro */
#define Q2(x)     ((TFp)((x)*4.0))           /**< Q2 fixed point number definition macro */
#define Q1(x)     ((TFp)((x)*2.0))           /**< Q1 fixed point number definition macro */
#define Q0(x)     ((TFp)((x)*1.0))           /**< Q0 fixed point number definition macro */

/**
  \brief Definition of the CORDIC angle table
 
  These angles define the angle iteration step sizes of the CORDIC algorithm.
*/
const TAngle FPM_tCordicAngleTabQ15 [] = {
     8192,
     4836,
     2555,
     1297,
     651,
     326,
     163,
     81,
     41,
     20,
     10,
     5,
     3,
     1,
     1,
     0
};

const TFp FPM_tSineTabQ15[] = {//256, sin0 to sin360
      Q15(0.0000000000),
      Q15(0.0245412285),
      Q15(0.0490676743),
      Q15(0.0735645636),
      Q15(0.0980171403),
      Q15(0.1224106752),
      Q15(0.1467304745),
      Q15(0.1709618888),
      Q15(0.1950903220),
      Q15(0.2191012402),
      Q15(0.2429801799),
      Q15(0.2667127575),
      Q15(0.2902846773),
      Q15(0.3136817404),
      Q15(0.3368898534),
      Q15(0.3598950365),
      Q15(0.3826834324),
      Q15(0.4052413140),
      Q15(0.4275550934),
      Q15(0.4496113297),
      Q15(0.4713967368),
      Q15(0.4928981922),
      Q15(0.5141027442),
      Q15(0.5349976199),
      Q15(0.5555702330),
      Q15(0.5758081914),
      Q15(0.5956993045),
      Q15(0.6152315906),
      Q15(0.6343932842),
      Q15(0.6531728430),
      Q15(0.6715589548),
      Q15(0.6895405447),
      Q15(0.7071067812),
      Q15(0.7242470830),
      Q15(0.7409511254),
      Q15(0.7572088465),
      Q15(0.7730104534),
      Q15(0.7883464276),
      Q15(0.8032075315),
      Q15(0.8175848132),
      Q15(0.8314696123),
      Q15(0.8448535652),
      Q15(0.8577286100),
      Q15(0.8700869911),
      Q15(0.8819212643),
      Q15(0.8932243012),
      Q15(0.9039892931),
      Q15(0.9142097557),
      Q15(0.9238795325),
      Q15(0.9329927988),
      Q15(0.9415440652),
      Q15(0.9495281806),
      Q15(0.9569403357),
      Q15(0.9637760658),
      Q15(0.9700312532),
      Q15(0.9757021300),
      Q15(0.9807852804),
      Q15(0.9852776424),
      Q15(0.9891765100),
      Q15(0.9924795346),
      Q15(0.9951847267),
      Q15(0.9972904567),
      Q15(0.9987954562),
      Q15(0.9996988187),
      Q15(0.9999999999),
      Q15(0.9996988187),
      Q15(0.9987954562),
      Q15(0.9972904567),
      Q15(0.9951847267),
      Q15(0.9924795346),
      Q15(0.9891765100),
      Q15(0.9852776424),
      Q15(0.9807852804),
      Q15(0.9757021300),
      Q15(0.9700312532),
      Q15(0.9637760658),
      Q15(0.9569403357),
      Q15(0.9495281806),
      Q15(0.9415440652),
      Q15(0.9329927988),
      Q15(0.9238795325),
      Q15(0.9142097557),
      Q15(0.9039892931),
      Q15(0.8932243012),
      Q15(0.8819212643),
      Q15(0.8700869911),
      Q15(0.8577286100),
      Q15(0.8448535652),
      Q15(0.8314696123),
      Q15(0.8175848132),
      Q15(0.8032075315),
      Q15(0.7883464276),
      Q15(0.7730104534),
      Q15(0.7572088465),
      Q15(0.7409511254),
      Q15(0.7242470830),
      Q15(0.7071067812),
      Q15(0.6895405447),
      Q15(0.6715589548),
      Q15(0.6531728430),
      Q15(0.6343932842),
      Q15(0.6152315906),
      Q15(0.5956993045),
      Q15(0.5758081914),
      Q15(0.5555702330),
      Q15(0.5349976199),
      Q15(0.5141027442),
      Q15(0.4928981922),
      Q15(0.4713967368),
      Q15(0.4496113297),
      Q15(0.4275550934),
      Q15(0.4052413140),
      Q15(0.3826834324),
      Q15(0.3598950365),
      Q15(0.3368898534),
      Q15(0.3136817404),
      Q15(0.2902846773),
      Q15(0.2667127575),
      Q15(0.2429801799),
      Q15(0.2191012402),
      Q15(0.1950903220),
      Q15(0.1709618888),
      Q15(0.1467304745),
      Q15(0.1224106752),
      Q15(0.0980171403),
      Q15(0.0735645636),
      Q15(0.0490676743),
      Q15(0.0245412285),
      Q15(0.0000000000),
      Q15(-0.0245412285),
      Q15(-0.0490676743),
      Q15(-0.0735645636),
      Q15(-0.0980171403),
      Q15(-0.1224106752),
      Q15(-0.1467304745),
      Q15(-0.1709618888),
      Q15(-0.1950903220),
      Q15(-0.2191012402),
      Q15(-0.2429801799),
      Q15(-0.2667127575),
      Q15(-0.2902846773),
      Q15(-0.3136817404),
      Q15(-0.3368898534),
      Q15(-0.3598950365),
      Q15(-0.3826834324),
      Q15(-0.4052413140),
      Q15(-0.4275550934),
      Q15(-0.4496113297),
      Q15(-0.4713967368),
      Q15(-0.4928981922),
      Q15(-0.5141027442),
      Q15(-0.5349976199),
      Q15(-0.5555702330),
      Q15(-0.5758081914),
      Q15(-0.5956993045),
      Q15(-0.6152315906),
      Q15(-0.6343932842),
      Q15(-0.6531728430),
      Q15(-0.6715589548),
      Q15(-0.6895405447),
      Q15(-0.7071067812),
      Q15(-0.7242470830),
      Q15(-0.7409511254),
      Q15(-0.7572088465),
      Q15(-0.7730104534),
      Q15(-0.7883464276),
      Q15(-0.8032075315),
      Q15(-0.8175848132),
      Q15(-0.8314696123),
      Q15(-0.8448535652),
      Q15(-0.8577286100),
      Q15(-0.8700869911),
      Q15(-0.8819212643),
      Q15(-0.8932243012),
      Q15(-0.9039892931),
      Q15(-0.9142097557),
      Q15(-0.9238795325),
      Q15(-0.9329927988),
      Q15(-0.9415440652),
      Q15(-0.9495281806),
      Q15(-0.9569403357),
      Q15(-0.9637760658),
      Q15(-0.9700312532),
      Q15(-0.9757021300),
      Q15(-0.9807852804),
      Q15(-0.9852776424),
      Q15(-0.9891765100),
      Q15(-0.9924795346),
      Q15(-0.9951847267),
      Q15(-0.9972904567),
      Q15(-0.9987954562),
      Q15(-0.9996988187),
      Q15(-1.0000000000),
      Q15(-0.9996988187),
      Q15(-0.9987954562),
      Q15(-0.9972904567),
      Q15(-0.9951847267),
      Q15(-0.9924795346),
      Q15(-0.9891765100),
      Q15(-0.9852776424),
      Q15(-0.9807852804),
      Q15(-0.9757021300),
      Q15(-0.9700312532),
      Q15(-0.9637760658),
      Q15(-0.9569403357),
      Q15(-0.9495281806),
      Q15(-0.9415440652),
      Q15(-0.9329927988),
      Q15(-0.9238795325),
      Q15(-0.9142097557),
      Q15(-0.9039892931),
      Q15(-0.8932243012),
      Q15(-0.8819212643),
      Q15(-0.8700869911),
      Q15(-0.8577286100),
      Q15(-0.8448535652),
      Q15(-0.8314696123),
      Q15(-0.8175848132),
      Q15(-0.8032075315),
      Q15(-0.7883464276),
      Q15(-0.7730104534),
      Q15(-0.7572088465),
      Q15(-0.7409511254),
      Q15(-0.7242470830),
      Q15(-0.7071067812),
      Q15(-0.6895405447),
      Q15(-0.6715589548),
      Q15(-0.6531728430),
      Q15(-0.6343932842),
      Q15(-0.6152315906),
      Q15(-0.5956993045),
      Q15(-0.5758081914),
      Q15(-0.5555702330),
      Q15(-0.5349976199),
      Q15(-0.5141027442),
      Q15(-0.4928981922),
      Q15(-0.4713967368),
      Q15(-0.4496113297),
      Q15(-0.4275550934),
      Q15(-0.4052413140),
      Q15(-0.3826834324),
      Q15(-0.3598950365),
      Q15(-0.3368898534),
      Q15(-0.3136817404),
      Q15(-0.2902846773),
      Q15(-0.2667127575),
      Q15(-0.2429801799),
      Q15(-0.2191012402),
      Q15(-0.1950903220),
      Q15(-0.1709618888),
      Q15(-0.1467304745),
      Q15(-0.1224106752),
      Q15(-0.0980171403),
      Q15(-0.0735645636),
      Q15(-0.0490676743),
      Q15(-0.0245412285),
};


/***************************const value(int16_t)*****************************/
#ifdef OLD
const int16_t QMATH_SineTable512[]= //sin0-sin90, 90/512
{
		0,101,201,302,402,503,603,704,
		804,905,1005,1106,1206,1307,1407,1507,
		1608,1708,1809,1909,2009,2110,2210,2310,
		2411,2511,2611,2711,2811,2912,3012,3112,
		3212,3312,3412,3512,3612,3712,3812,3911,
		4011,4111,4211,4310,4410,4510,4609,4709,
		4808,4907,5007,5106,5205,5305,5404,5503,
		5602,5701,5800,5899,5998,6097,6195,6294,
		6393,6491,6590,6688,6787,6885,6983,7081,
		7180,7278,7376,7473,7571,7669,7767,7864,
		7962,8059,8157,8254,8351,8449,8546,8643,
		8740,8836,8933,9030,9127,9223,9319,9416,
		9512,9608,9704,9800,9896,9992,10088,10183,
		10279,10374,10469,10565,10660,10755,10850,10945,
		11039,11134,11228,11323,11417,11511,11605,11699,
		11793,11887,11980,12074,12167,12261,12354,12447,
		12540,12633,12725,12818,12910,13003,13095,13187,
		13279,13371,13463,13554,13646,13737,13828,13919,
		14010,14101,14192,14282,14373,14463,14553,14643,
		14733,14823,14912,15002,15091,15180,15269,15358,
		15447,15535,15624,15712,15800,15888,15976,16064,
		16151,16239,16326,16413,16500,16587,16673,16760,
		16846,16932,17018,17104,17190,17275,17361,17446,
		17531,17616,17700,17785,17869,17953,18037,18121,
		18205,18288,18372,18455,18538,18621,18703,18786,
		18868,18950,19032,19114,19195,19277,19358,19439,
		19520,19601,19681,19761,19841,19921,20001,20081,
		20160,20239,20318,20397,20475,20554,20632,20710,
		20788,20865,20943,21020,21097,21174,21251,21327,
		21403,21479,21555,21631,21706,21781,21856,21931,
		22006,22080,22154,22228,22302,22375,22449,22522,
		22595,22668,22740,22812,22884,22956,23028,23099,
		23170,23241,23312,23383,23453,23523,23593,23663,
		23732,23801,23870,23939,24008,24076,24144,24212,
		24279,24347,24414,24481,24548,24614,24680,24746,
		24812,24878,24943,25008,25073,25138,25202,25266,
		25330,25394,25457,25520,25583,25646,25708,25771,
		25833,25894,25956,26017,26078,26139,26199,26259,
		26320,26379,26439,26498,26557,26616,26674,26733,
		26791,26848,26906,26963,27020,27077,27133,27190,
		27246,27301,27357,27412,27467,27522,27576,27630,
		27684,27738,27791,27844,27897,27950,28002,28054,
		28106,28158,28209,28260,28311,28361,28411,28461,
		28511,28560,28610,28658,28707,28755,28803,28851,
		28899,28946,28993,29040,29086,29132,29178,29224,
		29269,29314,29359,29404,29448,29492,29535,29579,
		29622,29665,29707,29750,29792,29833,29875,29916,
		29957,29997,30038,30078,30118,30157,30196,30235,
		30274,30312,30350,30388,30425,30462,30499,30536,
		30572,30608,30644,30680,30715,30750,30784,30819,
		30853,30886,30920,30953,30986,31018,31050,31082,
		31114,31146,31177,31207,31238,31268,31298,31328,
		31357,31386,31415,31443,31471,31499,31527,31554,
		31581,31608,31634,31660,31686,31711,31737,31761,
		31786,31810,31834,31858,31881,31904,31927,31950,
		31972,31994,32015,32037,32058,32078,32099,32119,
		32138,32158,32177,32196,32214,32233,32251,32268,
		32286,32303,32319,32336,32352,32368,32383,32398,
		32413,32428,32442,32456,32470,32483,32496,32509,
		32522,32534,32546,32557,32568,32579,32590,32600,
		32610,32620,32629,32638,32647,32656,32664,32672,
		32679,32686,32693,32700,32706,32712,32718,32723,
		32729,32733,32738,32742,32746,32749,32753,32756,
		32758,32760,32762,32764,32766,32767,32767,32767,
		32767
};
#endif


/*****************************************************************************************************************
 * GLOBAL FUNCTIONS **********************************************************************************************
 *****************************************************************************************************************/

/******************************************************************************
 int16_t QMATH_sin(int16_t angle)
 ******************************************************************************/
#ifdef OLD
/** \brief		Output sin value.
 *
 *  \details	search the table and output the sin value.
 *
 *  \param
 */
int16_t QMATH_sin(int16_t angle)
{
	int16_t sinValue;

	if(angle >= Q11_MAX)
	{
		angle -= Q11_MAX;
	}
	else if (angle < 0)
	{
		angle += Q11_MAX;
	}
	else 
	{ 

	}

	if (angle <= QMATH_SINCOS_90DEGREE)
	{
		sinValue = QMATH_SineTable512[angle];
	}
	else
	{
		if (angle <= QMATH_SINCOS_180DEGREE)
		{
			sinValue = QMATH_SineTable512[QMATH_SINCOS_180DEGREE - angle];
		}
		else
		{
			if (angle <= QMATH_SINCOS_270DEGREE)
			{
				sinValue = -QMATH_SineTable512[angle - QMATH_SINCOS_180DEGREE];
			}
			else
			{
				sinValue = -QMATH_SineTable512[QMATH_SINCOS_360DEGREE - angle];
			}
		}
	}

	return sinValue;
}
#endif
/******************************************************************************
 * void FPM_vCart2Pol(TCartNum* tCN, TPolNum* tPN)
 ******************************************************************************/
void FPM_vCart2Pol(TCartNum* tCN, TPolNum* tPN)
{
   int32_t    slIdx;
   TCartNum tCartNum;
   TCartNum tCartNum_;
   TAngle   tAngOffset;
   if (tCN->tRe < 0)
   {
      /* Quadrant II or III */
      if (tCN->tIm < 0)
      {
         /* Quadrant III */
         tCartNum.tRe = -tCN->tIm;
         tCartNum.tIm = tCN->tRe;
         tAngOffset   = -(TAngle)FPM_PI_HALF;
      }
      else
      {
         /* Quadrant II */
         tCartNum.tRe = tCN->tIm;
         tCartNum.tIm = -tCN->tRe;
         tAngOffset   = (TAngle)FPM_PI_HALF;
      }
   }
   else
   {
      /* Quadrant I or IV*/
      tCartNum   = *tCN;
      tAngOffset = (TAngle)0;
   }
   tPN->siAngle = 0;
   for (slIdx = 0; slIdx < FPM_CORDIC_ITERATIONS; slIdx++)
   {
      if (tCartNum.tIm < 0)
      {
         /* Imaginary part is negative => rotate counter clock wise */
         tCartNum_.tRe = tCartNum.tRe - (tCartNum.tIm >> slIdx);
         tCartNum_.tIm = tCartNum.tIm + (tCartNum.tRe >> slIdx);

         /* Accumulate angle */
         tPN->siAngle -= FPM_tCordicAngleTabQ15[slIdx];
      }
      else
      {
         /* Imaginary part is positive => rotate clock wise */
         tCartNum_.tRe = tCartNum.tRe + (tCartNum.tIm >> slIdx);
         tCartNum_.tIm = tCartNum.tIm - (tCartNum.tRe >> slIdx);

         /* Accumulate angle */
         tPN->siAngle += FPM_tCordicAngleTabQ15[slIdx];
      }
      /* Prepare next iteration */
      tCartNum = tCartNum_;
   }
   tPN->tMag     = (FPM_CORDIC_SCALE_FACTOR_Q16 * tCartNum.tRe) >> 16;
   tPN->siAngle += tAngOffset;
}

/******************************************************************************
 * uint32_t FPM_ulSqrt(uint32_t ulRadicand)
 ******************************************************************************/
uint32_t FPM_ulSqrt(uint32_t ulRadicand)
{
   uint32_t ulRem  = 0;
   uint32_t ulRoot = 0;
   int32_t  slIdx;
   for (slIdx = 0; slIdx < 16; slIdx++)
   {
      ulRoot     <<= 1;
      ulRem        = ((ulRem << 2) + (ulRadicand >> 30));
      ulRadicand <<= 2;
      ulRoot++;
      if (ulRoot <= ulRem)
      {
         ulRem -= ulRoot;
         ulRoot++;
      }
      else
      {
         ulRoot--;
      }
   }
   return (ulRoot >> 1);
}

int16_t QMATH_max(int16_t value1, int16_t value2)
{
	if(value1 > value2)
		{
			return value1;
		}
	else
		{
			return value2;
		}


}


int16_t QMATH_min(int16_t value1, int16_t value2)
{
	if (value1 < value2)
	{
		return(value1);
	}
	else
	{
		return(value2);
	}
}

int16_t QMATH_limit(int16_t value, int16_t limitMin, int16_t limitMax)
{
	int16_t temp;
	if (value < limitMin)
	{
		temp = limitMin;
	}
	else if (value > limitMax)
	{
		temp = limitMax;
	}
	else
	{
		temp = value;
	}
	return temp;
}

